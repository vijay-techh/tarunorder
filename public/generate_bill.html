<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Generate Bill</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>

  :root {
    --peacock: #016A70;
    --peacock-dark: #014d50;
    --accent: #02A2A8;
    --light-bg: #F5FEFF;
    --text: #023c3f;
    --card-bg: #ffffff;
    --border: #d9efef;
  }

  body {
    font-family: Inter, Arial, sans-serif;
    background: var(--light-bg);
    padding: 25px;
    margin: 0;
    color: var(--text);
  }

  .wrap {
    max-width: 1000px;
    margin: 0 auto;
    background: var(--card-bg);
    padding: 26px;
    border-radius: 14px;
    box-shadow: 0 8px 26px rgba(0, 0, 0, 0.08);
    border: 1px solid rgba(1,106,112,0.15);
  }

  h2 {
    margin: 0 0 6px;
    color: var(--peacock-dark);
    font-size: 26px;
  }

  .muted {
    font-size: 14px;
    color: #577c7e;
  }

  .top-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .back {
    background: var(--peacock);
    color: white;
    padding: 8px 16px;
    border-radius: 10px;
    text-decoration: none;
    font-size: 14px;
    transition: 0.2s;
    font-weight: 600;
  }

  .back:hover {
    background: var(--peacock-dark);
  }

  label {
    display: block;
    margin-top: 14px;
    font-weight: 600;
    color: var(--peacock-dark);
  }

  input, textarea, select {
    padding: 12px;
    width: 100%;
    margin-top: 6px;
    border: 1px solid #cfdede;
    border-radius: 8px;
    font-size: 15px;
    box-sizing: border-box;
    background: #ffffff;
    color: var(--text);
    transition: 0.2s;
  }

  input:focus, textarea:focus, select:focus {
    border: 1px solid var(--peacock);
    outline: none;
    box-shadow: 0 0 4px rgba(1,106,112,0.25);
  }

  .search-wrapper {
    margin-top: 10px;
    margin-bottom: 6px;
  }

  #searchResults {
    border: 1px solid #c3e2e2;
    border-radius: 8px;
    padding: 6px;
    background: white;
    max-height: 220px;
    overflow-y: auto;
    margin-top: 8px;
    display: none;
    box-shadow: 0 6px 18px rgba(0,0,0,0.05);
  }

  .sr-item {
    padding: 10px;
    border-bottom: 1px solid #eef4f4;
    cursor: pointer;
    font-size: 15px;
    transition: background 0.12s;
  }
  .sr-item:hover { background: #EAFDFC; }

  .products {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 10px;
  }

  .product-checkbox {
    padding: 10px 14px;
    border: 1px solid #c0dadb;
    background: #ffffff;
    border-radius: 8px;
    cursor: pointer;
    font-size: 15px;
    transition: 0.25s;
    color: var(--peacock-dark);
  }

  .product-checkbox:hover {
    background: var(--light-bg);
    border-color: var(--peacock);
  }

  .inline-row {
    display: flex;
    gap: 12px;
  }
  .inline-row > * { flex: 1; }

  .item-row {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-top: 12px;
    background: #f7ffff;
    border: 1px solid #cfeeee;
    padding: 12px;
    border-radius: 10px;
  }

  .item-row input { width: 130px; }

  .actions {
    margin-top: 20px;
    display: flex;
    gap: 14px;
    flex-wrap: wrap;
  }

  button {
    padding: 12px 20px;
    background: var(--peacock);
    border: none;
    border-radius: 8px;
    font-size: 16px;
    color: white;
    cursor: pointer;
    transition: 0.25s;
  }
  button:hover { background: var(--peacock-dark); }
  .secondary { background: #6e7c7e; }
  .secondary:hover { background: #515d5e; }

  #billPreview {
    margin-top: 25px;
    background: #F4FEFE;
    border: 1px solid #cceeee;
    border-radius: 12px;
    padding: 20px;
    display: none;
    box-shadow: 0 6px 20px rgba(0,0,0,0.06);
  }

  @media (max-width: 720px) {
    .item-row { flex-direction: column; }
    .top-row { flex-direction: column; align-items: flex-start; gap:12px; }
  }

  </style>
</head>

<body>
  <div class="wrap">
    <div class="top-row">
      <div><h2>Generate Bill</h2><div class="muted">Fetch existing customer or enter details manually</div></div>
      <a class="back" href="home.html">‚Üê Back</a>
    </div>

    <div class="search-wrapper">
      <label>Search Customer by name</label>
      <input id="searchName" autocomplete="off" placeholder="Type name.." />
      <div id="searchResults"></div>
    </div>

    <hr/>

    <label>Customer Name *</label>
    <input id="customerName" style="text-transform:uppercase" oninput="this.value=this.value.toUpperCase()">

    <label>Phone *</label>
    <input id="phone" maxlength="10" oninput="this.value=this.value.replace(/[^0-9]/g,'').slice(0,10);">

    <label>Additional Phone</label>
    <input id="altPhone" maxlength="10" oninput="this.value=this.value.replace(/[^0-9]/g,'').slice(0,10);">

    <label>Address *</label>
    <textarea id="address" style="text-transform:uppercase" oninput="this.value=this.value.toUpperCase()"></textarea>

    <label style="margin-top:14px">Products (select multiple)</label>
    <div id="productsList" class="products"></div>

    <div id="itemsContainer"></div>

    <div class="inline-row">
      <div><label>Rent Start</label><input type="date" id="rent_start"></div>
      <div><label>Rent End</label><input type="date" id="rent_end"></div>
    </div>

    <div class="actions">
      <button id="btnPreview">Generate Bill (Preview)</button>
      <button id="btnDownload">Download Bill</button>
      <button id="btnReset" class="secondary">Reset</button>
    </div>

    <div id="billPreview"></div>
  </div>


<script>
// short value helper
function val(id){ return document.getElementById(id).value.trim(); }

// ---------- CONFIG ----------
const PRODUCTS=["xframe","alige","piller box","wheels","painting ladder","motor","supportings","machine"];
const itemsContainer=document.getElementById("itemsContainer");
let savedPayload=null;

// Generate product checkboxes
const prodList=document.getElementById('productsList');
PRODUCTS.forEach(p=>{
  const box=document.createElement('div');
  box.className='product-checkbox';
  box.innerHTML=`<label><input type="checkbox" id="chk_${p}"> ${p}</label>`;
  prodList.appendChild(box);

  box.onclick=e=>{
    if(e.target.tagName==="INPUT")return;
    let chk=document.getElementById(`chk_${p}`);
    chk.checked=!chk.checked;
    toggleProductRow(p,chk.checked);
  };

  box.querySelector('input').addEventListener('change',e=>{
    toggleProductRow(p,e.target.checked);
  });
});

// Add/remove product rows
function toggleProductRow(prod,isChecked){
  if(isChecked){
    if(document.getElementById(`row_${prod}`))return;
    const row=document.createElement('div');
    row.className='item-row';
    row.id=`row_${prod}`;
    row.innerHTML=`
      <div style="flex:1"><strong>${prod}</strong></div>
      <input id="price_${prod}" type="number" min="0" step="0.01" placeholder="Price" />
      <input id="qty_${prod}" type="number" min="1" value="1" />
      <button type="button" onclick="removeProduct('${prod}')">Remove</button>`;
    itemsContainer.appendChild(row);
  } else removeProduct(prod);
}
function removeProduct(prod){
  const r=document.getElementById(`row_${prod}`);
  if(r)r.remove();
  const chk=document.getElementById(`chk_${prod}`);
  if(chk)chk.checked=false;
}

// Customer live search
const searchInput=document.getElementById("searchName");
const searchResults=document.getElementById("searchResults");

let searchTimer=null;
searchInput.addEventListener("keyup",()=>{
  clearTimeout(searchTimer);
  const q=searchInput.value.trim();
  if(!q){
    searchResults.style.display="none";
    searchResults.innerHTML="";
    return;
  }
  searchTimer=setTimeout(async()=>{
    const res=await fetch("/api/customers?q="+encodeURIComponent(q));
    const data=await res.json();
    if(!data.rows.length){
      searchResults.style.display="block";
      searchResults.innerHTML="<div class='muted'>No results</div>";
      return;
    }
    searchResults.style.display="block";
    searchResults.innerHTML=data.rows.map(r=>`
      <div class="sr-item" data-id="${r.id}">${escapeHtml(r.name)} ‚Äî ${escapeHtml(r.phone)}</div>
    `).join("");
    document.querySelectorAll(".sr-item").forEach(el=>{
      el.onclick=()=>selectCustomer(el.dataset.id);
    });
  },180);
});

function escapeHtml(s){return s?String(s).replace(/[&<>"]/g,(c=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"}[c]))):"";}

async function selectCustomer(id){
  const res=await fetch("/api/customer-details?id="+id);
  const data=await res.json();
  if(!data.success)return alert("Could not load customer");
  let c=data.customer;

  document.getElementById('customerName').value=c.name||'';
  document.getElementById('phone').value=c.phone||'';
  document.getElementById('altPhone').value=c.alt_phone||'';
  document.getElementById('address').value=c.address||'';

  searchResults.style.display="none";

  // reset product UI
  PRODUCTS.forEach(p=>{
    removeProduct(p);
    let chk=document.getElementById(`chk_${p}`);
    if(chk)chk.checked=false;
  });

  // load last order if exists
  if(data.orderDetails && data.orderDetails.length){
    const last=data.orderDetails[0];

    if(last.order.rent_start)
      document.getElementById("rent_start").value=last.order.rent_start.split("T")[0];

    if(last.order.rent_end)
      document.getElementById("rent_end").value=last.order.rent_end.split("T")[0];

    (last.items||[]).forEach(it=>{
      let p=it.product;
      document.getElementById(`chk_${p}`).checked=true;
      toggleProductRow(p,true);
      document.getElementById(`price_${p}`).value=it.price;
      document.getElementById(`qty_${p}`).value=it.quantity;
    });
  }
}

// Preview
document.getElementById("btnPreview").onclick=generatePreview;

function computeDays(s,e){
  if(!s||!e)return 1;
  const d=(new Date(e)-new Date(s))/(1000*3600*24)+1;
  return Math.max(1,Math.floor(d));
}

function collectItems(){
  const items=[];
  for(const p of PRODUCTS){
    let chk=document.getElementById(`chk_${p}`);
    if(chk && chk.checked){
      let price=parseFloat(document.getElementById(`price_${p}`).value||0);
      let qty=parseInt(document.getElementById(`qty_${p}`).value||0);
      if(price<=0||qty<=0)throw Error(`Invalid price/qty for ${p}`);
      items.push({product:p,price,quantity:qty});
    }
  }
  if(!items.length)throw Error("Select at least one product");
  return items;
}

function generatePreview(){
  try{
    let name=val("customerName"),phone=val("phone"),address=val("address"),alt=val("altPhone");
    if(!name||!phone||!address) return alert("Enter customer details");

    const s=document.getElementById('rent_start').value||null;
    const e=document.getElementById('rent_end').value||null;
    const days=computeDays(s,e);
    const items=collectItems();

    let total=0;
    const rows=items.map(it=>{
      let amt=it.price*it.quantity*days; total+=amt;
      return {...it,amount:amt};
    });

    savedPayload={name,phone,alt_phone:alt,address,rent_start:s,rent_end:e,items};

    const prev=document.getElementById("billPreview");
    prev.innerHTML=`<h3>Invoice Preview</h3><table border="1" cellpadding="6"><tr><th>Product</th><th>Price</th><th>Qty</th><th>Amount</th></tr>`+
      rows.map(r=>`<tr><td>${r.product}</td><td>${r.price}</td><td>${r.quantity}</td><td>${r.amount}</td></tr>`).join("")+
      `<tr><td colspan="3"><b>Total</b></td><td><b>${total}</b></td></tr></table>`;
    prev.style.display="block";
  }catch(e){alert(e.message);}
}

// DOWNLOAD (with mobile support)
function isMobile(){
  return /Android|iPhone|iPad|iPod|Mobile/i.test(navigator.userAgent);
}

document.getElementById("btnDownload").onclick=async()=>{
  if(!savedPayload){
    try{generatePreview();}catch(e){return alert("Fix inputs first");}
  }
  if(!savedPayload)return alert("No bill data");

  const res=await fetch("/api/generate-bill",{
    method:"POST",
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(savedPayload)
  });
  const data=await res.json();
  if(!data.success)return alert("Error generating bill");

  const fileUrl="/api/invoice/"+data.orderId;

  if(isMobile()){
    const link=document.createElement("a");
    link.href=fileUrl;
    link.download="invoice.pdf";
    document.body.appendChild(link);
    link.click();
    link.remove();
    alert("üì• Download started ‚Äî check Downloads folder");
  } else {
    window.open(fileUrl,"_blank");
  }
};

// RESET
document.getElementById("btnReset").onclick=()=>{
  ["customerName","phone","altPhone","address","rent_start","rent_end","searchName"].forEach(id=>document.getElementById(id).value="");
  searchResults.style.display="none";
  document.getElementById("billPreview").style.display="none";
  savedPayload=null;
  PRODUCTS.forEach(removeProduct);
};

</script>
</body>
</html>
