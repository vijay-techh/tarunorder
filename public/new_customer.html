<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>New Customer</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />

<style>
  * { box-sizing: border-box; }

  body {
    font-family: Arial, sans-serif;
    background: #f6f9fb;
    margin: 0;
    padding: 18px;
  }

  .card {
    background: #fff;
    padding: 20px;
    border-radius: 12px;
    max-width: 900px;
    margin: auto;
    box-shadow: 0 6px 20px rgba(0,0,0,0.07);
  }

  h2 {
    font-size: 20px;
    margin-bottom: 12px;
  }

  label {
    display: block;
    margin-top: 12px;
    font-weight: 600;
    font-size: 14px;
  }

  input, textarea {
    padding: 10px;
    width: 100%;
    margin-top: 6px;
    border: 1px solid #d7d7d7;
    border-radius: 6px;
    font-size: 15px;
  }

  /* Product list */
  .products {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(115px, 1fr));
    gap: 8px;
    margin-top: 10px;
  }

  .product-checkbox {
    border: 1px solid #ccc;
    padding: 10px;
    border-radius: 6px;
    background: #fafafa;
    font-size: 14px;
  }

  /* Item rows */
  .item-row {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 10px;
    align-items: center;
    padding: 8px;
    border: 1px solid #eee;
    border-radius: 8px;
    background: #fafafa;
  }

  .item-row strong {
    flex: 1 1 100%;
    font-size: 14px;
  }

  .item-row input {
    width: calc(50% - 4px);
    min-width: 120px;
  }

  .item-row button {
    width: 100%;
    background: #d9534f;
    border-radius: 6px;
  }

  /* Buttons */
  button {
    margin-top: 14px;
    padding: 12px 18px;
    background: #222;
    color: #fff;
    border: none;
    border-radius: 7px;
    cursor: pointer;
    font-size: 15px;
    width: 100%;
  }

  button:nth-of-type(2){
    background: #666;
    margin-top: 8px;
  }

  a.back-btn {
    display: inline-block;
    font-size: 14px;
    margin-bottom: 8px;
    background: #e5e5e5;
    padding: 6px 12px;
    border-radius: 6px;
    text-decoration: none;
    color: #222;
  }

  /* ------------------------------
   EXTRA MOBILE RESPONSIVE CSS
   ------------------------------ */

@media (max-width: 600px) {

  body {
    padding: 10px;
  }

  .card {
    padding: 16px;
    border-radius: 10px;
  }

  h2 {
    font-size: 18px;
  }

  label {
    font-size: 13px;
  }

  input, textarea {
    font-size: 14px;
    padding: 9px;
  }

  /* Products grid more compact for small screens */
  .products {
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
    gap: 6px;
  }

  .product-checkbox {
    font-size: 13px;
    padding: 8px;
  }

  /* Items layout stack better on small screen */
  .item-row {
    flex-direction: column;
    align-items: stretch;
    text-align: left;
  }

  .item-row input {
    width: 100%;
  }

  .item-row button {
    width: 100%;
  }

  /* Buttons full width */
  button {
    width: 100% !important;
    font-size: 14px;
    padding: 11px;
  }

  a.back-btn {
    font-size: 13px;
    padding: 6px 10px;
  }
}


</style>
</head>
<body>

<div class="card">
  <h2>New Customer — Create Order</h2>
  <a href="home.html" class="back-btn">← Back</a>

  <label>Date (auto)</label>
  <input id="order_date" readonly />

  <label>Customer Name *</label>
  <input id="name" />

  <label>Phone *</label>
  <input id="phone" />

  <label>Alt Phone</label>
  <input id="alt_phone" />

  <label>Address *</label>
  <textarea id="address" rows="2"></textarea>

  <label>Products</label>
  <div id="productsList" class="products"></div>

  <div id="itemsContainer"></div>

  <label>Rent Start</label>
  <input type="date" id="rent_start" />

  <label>Rent End</label>
  <input type="date" id="rent_end" />

  <button onclick="submitForm()">Submit</button>
  <button onclick="resetForm()">Reset</button>
</div>

<script>
const PRODUCTS = ["xframe","alige","piller box","wheels","painting ladder","motor","supportings","machine"];

document.getElementById("order_date").value = new Date().toISOString().slice(0,10);

PRODUCTS.forEach(p=>{
  document.getElementById("productsList").innerHTML += `
    <div class="product-checkbox">
      <input type="checkbox" onchange="toggleItem('${p}')" id="chk_${p}"> ${p}
    </div>`;
});

function toggleItem(p){
  const chk=document.getElementById(`chk_${p}`).checked;
  if(chk){
    document.getElementById("itemsContainer").innerHTML += `
      <div class="item-row" id="row_${p}">
        <strong>${p}</strong>
        <input id="price_${p}" placeholder="Price" type="number">
        <input id="qty_${p}" placeholder="Qty" type="number" value="1">
        <button onclick="removeRow('${p}')">Remove</button>
      </div>`;
  } else removeRow(p);
}

function removeRow(p){
  const r=document.getElementById(`row_${p}`);
  if(r) r.remove();
  document.getElementById(`chk_${p}`).checked=false;
}

function resetForm(){ location.reload(); }

async function submitForm(){
  const name=document.getElementById('name').value.trim();
  const phone=document.getElementById('phone').value.trim();
  const address=document.getElementById('address').value.trim();
  const alt_phone=document.getElementById('alt_phone').value.trim();
  const rent_start=document.getElementById('rent_start').value || null;
  const rent_end=document.getElementById('rent_end').value || null;

  if(!name||!phone||!address){
    alert("Please fill name, phone and address");
    return;
  }

  const items=[];
  for(const p of PRODUCTS){
    if(document.getElementById(`chk_${p}`).checked){
      const price=parseFloat(document.getElementById(`price_${p}`).value || "0");
      const qty=parseInt(document.getElementById(`qty_${p}`).value || "0",10);
      if(!isFinite(price)||price<=0||qty<=0){
        alert(`Enter valid price & qty for ${p}`);
        return;
      }
      items.push({product:p,price,quantity:qty});
    }
  }

  if(items.length===0) return alert("Select at least one product");

  const payload = {
    name, phone, alt_phone, address, rent_start, rent_end,
    items, order_date: new Date().toISOString().slice(0,10)
  };

  try{
    const res=await fetch('/api/new-customer',{
      method:'POST', headers:{'Content-Type':'application/json'},
      body:JSON.stringify(payload)
    });

    const data=await res.json();
    if(!res.ok||!data.success) return alert(data.error||"Server error");

    const cid=data.customerId;
    if(!cid) return alert("Error: customerId not received");
    window.location.href=`customer_details.html?customerId=${cid}`;

  } catch(err){
    console.error(err);
    alert("Server error");
  }
}
</script>

</body>
</html>
